name: build-swoole-cli

on: [ push ]

jobs:
  linux:
    if: 1
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Prepare Source Code
        run: |
          env
          docker info
          id -u
          id -g
          who
      - name: Prepare Libraries and Extensions
        uses: addnab/docker-run-action@v3
        with:
          image: docker.io/jingjingxyk/build-swoole-cli:download-box-nginx-alpine-20230429T061856Z
          options: -v ${{ github.workspace }}:/work
          run: |
            set -eux
            cd /work
            mkdir -p pool/lib
            mkdir -p pool/ext
            mkdir -p ext
            cp -rf /usr/share/nginx/html/extensions/* pool/ext
            cp -rf /usr/share/nginx/html/libraries/* pool/lib
            cat semicolon_delimited_script
            ls -lha .
      - name: Prepare
        uses: addnab/docker-run-action@v3
        with:
          image: docker.io/jingjingxyk/build-swoole-cli:native-php-all-dependencies-alpine-20230429T064207Z
          options: -v ${{ github.workspace }}:/work -w /work
          run: |
            pwd
            set -uex
            export PATH=/work/bin/runtime:$PATH
            composer update --no-dev  --optimize-autoloader
            php prepare.php  +inotify +apcu +ds -mysqli -soap -mongodb
            chmod a+x make.sh
            head -n 20 make.sh
            sh make.sh php_src
            ls -lh /usr/
      - name: Build
        uses: addnab/docker-run-action@v3
        with:
          image: docker.io/jingjingxyk/build-swoole-cli:native-php-all-dependencies-alpine-20230429T064207Z
          options: -v ${{ github.workspace }}:/work -w /work
          run: |
            ./make.sh config
            ./make.sh build
            ./make.sh archive
            ./thirdparty/php_src/sapi/cli/php -v
            mkdir -p bin
            cp thirdparty/php_src/sapi/cli/php ./bin
            strip ./bin/php
      - name: production artifacts
        uses: actions/upload-artifact@v3
        with:
          name: linux-php-cli-dist
          retention-days: 7
          path: bin/php
      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: php-cli-v8.2.4-linux-x64.tar.xz
  cygwin:
    if: 0
    runs-on: windows-latest
    steps:
      - name: Prepare git
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf
      - uses: actions/checkout@v3
      - name: Cache cygwin packages
        id: cache-cygwin
        uses: actions/cache@v3
        env:
          cache-name: cache-cygwin-packages
        with:
          path: C:/cygwin-packages
          key: ${{ runner.os }}-build-${{ env.cache-name }}
      - name: Install deps
        uses: cygwin/cygwin-install-action@v2
        with:
          platform: x64
          packages: make wget tar libtool re2c bison gcc-g++ autoconf automake openssl libpcre2-devel libssl-devel libcurl-devel libxml2-devel libxslt-devel libgmp-devel ImageMagick libpng-devel libjpeg-devel libfreetype-devel libwebp-devel libsqlite3-devel zlib-devel libbz2-devel liblz4-devel liblzma-devel libzip-devel libicu-devel libonig-devel libcares-devel libsodium-devel libyaml-devel libMagick-devel libzstd-devel libbrotli-devel libreadline-devel  libintl-devel libpq-devel libssh2-devel libidn2-devel gettext-devel coreutils openssl-devel
      - name: Install re2c
        run: |
          bash ./sapi/scripts/cygwin/install-re2c.sh
      - name: Configure
        run: |
          uname -a
          git submodule update --init
          bash ./sapi/scripts/cygwin/cygwin-config-ext.sh
          bash ./sapi/scripts/cygwin/cygwin-config.sh
      - name: Build
        run: |
          bash ./sapi/scripts/cygwin/cygwin-build.sh
          ./bin/swoole-cli -v
      - name: Archive
        run: |
          bash ./sapi/scripts/cygwin/cygwin-archive.sh
      - name: production artifacts
        uses: actions/upload-artifact@v3
        with:
          name: cygwin-swoole-cli-dist
          path: |
            bin/swoole-cli.exe
      - name: gh release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: swoole-cli-*-cygwin-x64.zip
          draft: true
          prerelease: true
  macos:
    if: 1
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - name: Configure
        run: |
          git submodule update --init

          brew install  wget curl  libtool automake gettext coreutils re2c
          which glibtool
          ln -sf /usr/local/bin/glibtool /usr/local/bin/libtool
          ln -sf /usr/local/bin/glibtoolize /usr/local/bin/libtoolize
          sudo mkdir -p pool/lib
          sudo mkdir -p pool/ext
      - name: Cache
        uses: actions/cache@v3
        id: all-archive-cache
        with:
          path: |
            ${GITHUB_WORKSPACE}/var/all-archive.zip
            ${GITHUB_WORKSPACE}/bin/runtime/php
            ${GITHUB_WORKSPACE}/bin/runtime/composer
          key: all-archive
      - name: Prepare runtime
        if: ${{ steps.all-archive-cache.outputs.cache-hit != 'true' }}
        run: |
          sudo mkdir -p pool/lib
          sudo mkdir -p pool/ext
          sudo mkdir -p bin/runtime

          sudo sh  sapi/quickstart/setup-php-runtime.sh
          export PATH=${GITHUB_WORKSPACE}/bin/runtime:$PATH
          sudo sh sapi/download-box/download-box-get-archive-from-server.sh


      - name: prepare
        run: |
          sudo mkdir -p pool/lib
          sudo mkdir -p pool/ext
          sudo mkdir -p bin/runtime
          export PATH=${GITHUB_WORKSPACE}/bin/runtime:$PATH
          sudo sh sapi/download-box/download-box-get-archive-from-server.sh

          sudo composer update --no-dev  --optimize-autoloader
          sudo php prepare.php --without-docker=1  --with-build-type=release  +ds +apcu

      - name: Build
        run: |
          chmod a+x ./make.sh
          ./make.sh all-library
          ./make.sh config
          ./make.sh build
          ./make.sh archive
          ./thirdparty/php_src/sapi/cli/php -v
          mkdir -p bin
          cp thirdparty/php_src/sapi/cli/php ./bin
          strip ./bin/php

      - name: Archive production artifacts
        uses: actions/upload-artifact@v3
        with:
          name: macos-x86_64-swoole-cli-dist
          path: bin/php
      - name: gh release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: swoole-cli-v*-macos-x64.tar.xz
          draft: true
          prerelease: true
